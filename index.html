<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { --bg: #000; --card: #111; --accent: #f0b90b; --red: #ff4444; --border: #222; }
        body { background: var(--bg); color: #fff; font-family: -apple-system, sans-serif; margin: 0; padding: 0; height: 100vh; overflow: hidden; }
        .screen { display: none; flex-direction: column; height: 100vh; padding: 10px; box-sizing: border-box; overflow-y: auto; }
        .active { display: flex; }

        /* Trade Status Card */
        .trade-status { background: #0a0a0a; border: 1px solid var(--accent); border-radius: 12px; padding: 12px; margin-bottom: 15px; display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; text-align: center; }
        .trade-status div { font-size: 10px; color: #666; text-transform: uppercase; }
        .trade-status b { display: block; font-size: 14px; color: var(--accent); margin-top: 4px; }

        .btn-main { background: var(--card); border: 1px solid var(--border); color: #fff; padding: 18px; border-radius: 12px; margin-bottom: 10px; font-weight: bold; text-align: left; display: flex; justify-content: space-between; border-left: 5px solid var(--accent); width: 100%; font-size: 15px; cursor: pointer; }
        
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; }
        .day { aspect-ratio: 1; background: #0a0a0a; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 11px; border: 1px solid #1a1a1a; color: #444; }
        .day.done { background: var(--red) !important; color: #fff; border: none; box-shadow: 0 0 10px var(--red); }
        .day.today { border: 1px solid var(--accent); color: var(--accent); }

        .widget-box { background: var(--card); border-radius: 15px; border: 1px solid var(--border); overflow: hidden; margin-bottom: 15px; height: 350px; }
        .back { color: var(--accent); font-weight: bold; margin-bottom: 15px; display: block; cursor: pointer; }
        
        #tv-chart { flex-grow: 1; border: 1px solid var(--border); border-radius: 12px; min-height: 350px; }
        input { background: #000; border: 1px solid var(--border); color: #fff; padding: 10px; border-radius: 8px; margin-top: 5px; width: 100%; box-sizing: border-box; margin-bottom: 10px; }
    </style>
</head>
<body>

    <div id="scr-main" class="screen active">
        <h1 style="font-size: 24px; margin: 15px 0;">SMC <span style="color:var(--accent)">QUANTUM</span></h1>
        
        <div class="trade-status">
            <div>–¢–µ–∫—É—â–∞—è –§–∞–∑–∞<b id="st-phase">–û–ñ–ò–î–ê–ù–ò–ï</b></div>
            <div>–°—Ç–∞—Ç—É—Å –°–¥–µ–ª–∫–∏<b id="st-deal">–ù–ï–¢ –°–î–ï–õ–ö–ò</b></div>
            <div style="grid-column: span 2;">–î–µ—Ç–∞–ª–∏<b id="st-details">-</b></div>
        </div>

        <button class="btn-main" onclick="nav('scr-analysis')">üîç –ê–ù–ê–õ–ò–ó / –°–î–ï–õ–ö–ê <span>‚Üí</span></button>
        <button class="btn-main" style="border-left-color: var(--red)" onclick="nav('scr-info')">üåç –ò–ù–§–û –ò –ù–û–í–û–°–¢–ò <span>‚Üí</span></button>
        
        <div style="display: flex; gap: 8px;">
            <button style="flex:1;" class="btn-main" onclick="nav('scr-terminal')">üìä –ì–†–ê–§–ò–ö</button>
            <button style="flex:1;" class="btn-main" onclick="nav('scr-calendar')">üìÖ –ö–ê–õ–ï–ù–î–ê–†–¨</button>
        </div>
    </div>

    <div id="scr-analysis" class="screen">
        <span class="back" onclick="nav('scr-main')">‚Üê –ù–ê–ó–ê–î</span>
        <div id="analysis-flow">
            </div>
    </div>

    <div id="scr-info" class="screen">
        <span class="back" onclick="nav('scr-main')">‚Üê –ù–ê–ó–ê–î</span>
        
        <div style="background:var(--card); padding:15px; border-radius:12px; margin-bottom:15px; border:1px solid var(--border);">
            <small style="color:#888;">INDEX FEAR & GREED</small>
            <div id="fng-val" style="font-size: 22px; font-weight: bold; color: var(--accent); margin-top:5px;">...</div>
        </div>

        <div class="widget-box" id="econ-calendar-container"></div>

        <button class="btn-main" onclick="window.open('https://t.me/realDonaldTrump_rus', '_blank')" style="border-left-color: #0088cc;">
            üì¢ –ú–û–ù–ò–¢–û–†–ò–ù–ì –¢–†–ê–ú–ü–ê (–ü–ï–†–ï–ô–¢–ò) <span>‚Üí</span>
        </button>
    </div>

    <div id="scr-terminal" class="screen"><span class="back" onclick="nav('scr-main')">‚Üê BACK</span><div id="tv-chart"></div></div>
    <div id="scr-calendar" class="screen"><span class="back" onclick="nav('scr-main')">‚Üê BACK</span><div id="cal-render" class="cal-grid"></div></div>

    <script src="https://s3.tradingview.com/tv.js"></script>
    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        let state = {
            phase: '–û–∂–∏–¥–∞–Ω–∏–µ', 
            dealStatus: '–ù–µ—Ç —Å–¥–µ–ª–∫–∏',
            details: '-',
            history: (new URLSearchParams(window.location.search).get('dates') || "").split(',').filter(d => d)
        };

        function nav(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            if(id === 'scr-info') { loadFNG(); initEconWidget(); }
            if(id === 'scr-terminal') new TradingView.widget({"autosize": true, "symbol": "BINANCE:BTCUSDT", "interval": "15", "theme": "dark", "container_id": "tv-chart"});
            if(id === 'scr-calendar') renderCalendar();
            if(id === 'scr-analysis') showAnalysisStep('init');
        }

        function loadFNG() {
            fetch('https://api.alternative.me/fng/').then(r => r.json()).then(d => {
                document.getElementById('fng-val').innerText = d.data[0].value + ' (' + d.data[0].value_classification + ')';
            });
        }

        function initEconWidget() {
            const container = document.getElementById('econ-calendar-container');
            container.innerHTML = '';
            const script = document.createElement('script');
            script.type = 'text/javascript';
            script.src = 'https://s3.tradingview.com/external-embedding/embed-widget-events.js';
            script.async = true;
            script.text = JSON.stringify({ colorTheme: "dark", isMaximized: true, width: "100%", height: "100%", locale: "ru", importanceFilter: "-1,0,1", currencyFilter: "USD,EUR" });
            container.appendChild(script);
        }

        // --- –õ–û–ì–ò–ö–ê –û–ü–†–û–°–ê ---
        function showAnalysisStep(step) {
            const flow = document.getElementById('analysis-flow');
            if(step === 'init') {
                flow.innerHTML = `
                    <h3>–ö–∞–∫–∞—è —Å–µ–π—á–∞—Å —Ñ–∞–∑–∞?</h3>
                    <button class="btn-main" onclick="updateTradeState('–ö–æ—Ä—Ä–µ–∫—Ü–∏—è'); showAnalysisStep('correction')">–§–ê–ó–ê –ö–û–†–†–ï–ö–¶–ò–ò</button>
                    <button class="btn-main" onclick="updateTradeState('–ò–º–ø—É–ª—å—Å'); showAnalysisStep('impulse')">–§–ê–ó–ê –ò–ú–ü–£–õ–¨–°–ê</button>
                `;
            } else if(step === 'impulse') {
                flow.innerHTML = `
                    <div style="background:var(--card); padding:15px; border-radius:12px;">
                        <p>–°—Ç–∞—Ç—É—Å: –í –û–ñ–ò–î–ê–ù–ò–ò (–ò–º–ø—É–ª—å—Å)</p>
                        <button class="btn-main" onclick="updateTradeState('–ö–æ—Ä—Ä–µ–∫—Ü–∏—è'); showAnalysisStep('correction')">–ü–ï–†–ï–®–õ–ò –í –ö–û–†–†–ï–ö–¶–ò–Æ</button>
                        <button class="btn-main" onclick="confirmDay()">–ü–û–î–¢–í–ï–†–î–ò–¢–¨ –ê–ù–ê–õ–ò–ó –ò –í–´–ô–¢–ò</button>
                    </div>
                `;
            } else if(step === 'correction') {
                flow.innerHTML = `
                    <div style="background:var(--card); padding:15px; border-radius:12px;">
                        <p>–°—Ç–∞—Ç—É—Å: –û–ñ–ò–î–ê–ù–ò–ï –í–•–û–î–ê</p>
                        <button class="btn-main" onclick="showAnalysisStep('entry-form')">–ë–´–õ –í–•–û–î</button>
                        <button class="btn-main" onclick="confirmDay()">–í–•–û–î–ê –ù–ï –ë–´–õ–û (–í–´–ô–¢–ò)</button>
                    </div>
                `;
            } else if(step === 'entry-form') {
                flow.innerHTML = `
                    <h3>–î–µ—Ç–∞–ª–∏ —Å–¥–µ–ª–∫–∏</h3>
                    <input id="in-entry" type="text" placeholder="–¶–µ–Ω–∞ –≤—Ö–æ–¥–∞">
                    <input id="in-sl" type="text" placeholder="–°—Ç–æ–ø –ª–æ—Å—Å">
                    <input id="in-tp" type="text" placeholder="–¢–µ–π–∫ –ø—Ä–æ—Ñ–∏—Ç">
                    <input id="in-rr" type="text" placeholder="RR (–Ω–∞–ø—Ä. 1:3)">
                    <button class="btn-main" style="background:var(--accent); color:#000; justify-content:center;" onclick="saveDeal()">–°–û–•–†–ê–ù–ò–¢–¨ –°–î–ï–õ–ö–£</button>
                `;
            }
        }

        function updateTradeState(phase) {
            state.phase = phase;
            state.dealStatus = phase === '–ò–º–ø—É–ª—å—Å' ? '–û–∂–∏–¥–∞–Ω–∏–µ' : '–ü–æ–∏—Å–∫ –≤—Ö–æ–¥–∞';
            updateUI();
        }

        function saveDeal() {
            const entry = document.getElementById('in-entry').value;
            const sl = document.getElementById('in-sl').value;
            const tp = document.getElementById('in-tp').value;
            const rr = document.getElementById('in-rr').value;
            state.dealStatus = '–í –°–î–ï–õ–ö–ï';
            state.details = `E: ${entry} | SL: ${sl} | RR: ${rr}`;
            updateUI();
            confirmDay();
        }

        function updateUI() {
            document.getElementById('st-phase').innerText = state.phase;
            document.getElementById('st-deal').innerText = state.dealStatus;
            document.getElementById('st-details').innerText = state.details;
        }

        function confirmDay() {
            const today = new Date().toISOString().slice(0,10);
            if(!state.history.includes(today)) state.history.push(today);
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –±–æ—Ç—É
            tg.sendData(JSON.stringify({
                action: 'sync',
                date: today,
                trade: state
            }));
            
            // –ß—Ç–æ–±—ã –∫–∞–ª–µ–Ω–¥–∞—Ä—å –≤–∏–∑—É–∞–ª—å–Ω–æ –æ–±–Ω–æ–≤–∏–ª—Å—è –ü–ï–†–ï–î –∑–∞–∫—Ä—ã—Ç–∏–µ–º
            nav('scr-main');
            alert("–î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã. –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–∫—Ä–æ–µ—Ç—Å—è.");
            setTimeout(() => tg.close(), 500);
        }

        function renderCalendar() {
            const grid = document.getElementById('cal-render');
            grid.innerHTML = '';
            const now = new Date();
            const days = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
            for(let i=1; i<=days; i++) {
                const dStr = `${now.getFullYear()}-${(now.getMonth()+1).toString().padStart(2,'0')}-${i.toString().padStart(2,'0')}`;
                const cls = state.history.includes(dStr) ? 'day done' : 'day';
                grid.innerHTML += `<div class="${cls}">${i}</div>`;
            }
        }
    </script>
</body>
</html>