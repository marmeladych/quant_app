<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root { --accent: #4883fb; --text-grey: #848e9c; --glass: rgba(255, 255, 255, 0.03); --glass-border: rgba(255, 255, 255, 0.08); --red: #ff4d4f; --green: #00b07c; }
        body { background: #0b0e11; color: #fff; font-family: 'Inter', sans-serif; margin: 0; padding: 0; height: 100vh; overflow: hidden; }
        .screen { display: none; flex-direction: column; height: 100vh; padding: 20px; box-sizing: border-box; overflow-y: auto; }
        .active { display: flex; }
        .glass-card { background: var(--glass); backdrop-filter: blur(20px); border: 1px solid var(--glass-border); border-radius: 20px; padding: 15px; margin-bottom: 12px; }
        .label { font-size: 10px; font-weight: 800; color: var(--text-grey); text-transform: uppercase; margin-bottom: 4px; }
        .val { font-size: 15px; font-weight: 900; }
        .btn { background: var(--accent); color: #fff; border: none; padding: 15px; border-radius: 15px; font-weight: 900; cursor: pointer; margin-top: 10px; width: 100%; }
        .btn-sub { background: var(--glass); border: 1px solid var(--glass-border); color: #fff; padding: 12px; border-radius: 12px; font-weight: 700; cursor: pointer; width: 100%; }
        
        /* Календарь */
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; }
        .day { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 800; border-radius: 8px; color: #444; }
        .day.analyzed { background: var(--accent); color: #fff; }
        
        /* Список сделок */
        .trade-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid var(--glass-border); }
        .res-btn { padding: 4px 8px; border-radius: 6px; font-size: 10px; font-weight: 900; cursor: pointer; border: none; }

        .back { color: var(--text-grey); font-weight: 800; cursor: pointer; margin-bottom: 15px; display: block; }
        input { background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border); color: #fff; padding: 10px; border-radius: 10px; width: 100%; box-sizing: border-box; margin-bottom: 10px; }
    </style>
</head>
<body>
    <div id="scr-main" class="screen active">
        <h1 style="font-weight: 900; font-size: 22px;">SMC <span style="color:var(--accent)">QUANTUM</span></h1>
        <div class="glass-card" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <div><div class="label">Phase</div><div id="ui-phase" class="val">?</div></div>
            <div><div class="label">Status</div><div id="ui-status" class="val">?</div></div>
        </div>
        <button class="btn" onclick="nav('scr-analysis')">АНАЛИЗ</button>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
            <button class="btn-sub" onclick="nav('scr-terminal')">ГРАФИК</button>
            <button class="btn-sub" onclick="nav('scr-calendar')">КАЛЕНДАРЬ</button>
        </div>
    </div>

    <div id="scr-analysis" class="screen">
        <span class="back" onclick="nav('scr-main')">← НАЗАД</span>
        <div id="flow"></div>
    </div>

    <div id="scr-calendar" class="screen">
        <span class="back" onclick="nav('scr-main')">← НАЗАД</span>
        <div class="glass-card"><div id="month-name" style="text-align:center; font-weight:900; margin-bottom:10px;"></div><div id="cal-render" class="cal-grid"></div></div>
        
        <div class="label">Список сделок</div>
        <div id="trades-list" class="glass-card" style="max-height: 150px; overflow-y: auto; padding: 0;"></div>

        <div class="label">Winrate Curve</div>
        <div class="glass-card">
            <div id="winrate-val" style="font-size: 20px; font-weight: 900; color: var(--green);">0%</div>
            <div style="height: 40px; display: flex; align-items: flex-end; gap: 2px;" id="curve-render"></div>
        </div>
    </div>

    <div id="scr-terminal" class="screen">
        <span class="back" onclick="nav('scr-main')">← НАЗАД</span>
        <div id="tv-chart" style="height: 300px; border-radius: 15px; overflow: hidden;"></div>
        <textarea id="ui-notes" style="width:100%; height:100px; background:var(--glass); color:#fff; border:1px solid var(--glass-border); border-radius:15px; margin-top:10px; padding:10px;" oninput="saveAll()"></textarea>
    </div>

    <script src="https://s3.tradingview.com/tv.js"></script>
    <script>
        const tg = window.Telegram.WebApp;
        let state = { 
            phase: 'None', status: 'Ожидание', 
            history: [], // даты анализов
            trades: [],  // {id, entry, sl, rr, tp, res: '?' }
            notes: ''
        };

        function load() {
            tg.CloudStorage.getItem('smc_q_v10', (err, val) => {
                if(!err && val) { state = JSON.parse(val); updateUI(); }
            });
        }

        function nav(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            if(id === 'scr-analysis') renderFlow();
            if(id === 'scr-calendar') { renderCal(); renderTrades(); renderCurve(); }
            if(id === 'scr-terminal') new TradingView.widget({"autosize": true, "symbol": "BINANCE:BTCUSDT", "interval": "60", "theme": "dark", "container_id": "tv-chart"});
        }

        function renderFlow() {
            const f = document.getElementById('flow');
            if (state.phase === 'None' || state.phase === 'Impulse' && state.status === 'В ожидании') {
                f.innerHTML = `<div class="label">Выберите фазу:</div>
                    <button class="btn" onclick="setPhase('Impulse')">ФАЗА ИМПУЛЬСА</button>
                    <button class="btn-sub" style="margin-top:10px" onclick="setPhase('Correction')">ФАЗА КОРРЕКЦИИ</button>`;
            } else if (state.phase === 'Impulse' && state.status === 'Ожидание') {
                f.innerHTML = `<div class="label">Статус: Ожидание</div>
                    <button class="btn" onclick="setPhase('Correction')">ПЕРЕШЛИ В ФАЗУ КОРРЕКЦИИ</button>`;
            } else if (state.phase === 'Correction' && state.status === 'Ожидание входа') {
                f.innerHTML = `<div class="label">Статус: Ожидание входа</div>
                    <button class="btn" onclick="showTradeForm()">ВХОД БЫЛ</button>
                    <button class="btn-sub" style="margin-top:10px" onclick="nav('scr-main')">ВХОДА НЕ БЫЛО</button>`;
            } else if (state.status === 'В сделке') {
                f.innerHTML = `<div class="label">Вы уже в сделке.</div><button class="btn" onclick="nav('scr-main')">ОК</button>`;
            }
        }

        function setPhase(p) {
            state.phase = p;
            state.status = (p === 'Impulse') ? 'Ожидание' : 'Ожидание входа';
            markAnalyzed();
            saveAll(); renderFlow();
        }

        function showTradeForm() {
            document.getElementById('flow').innerHTML = `
                <div class="label">Параметры сделки</div>
                <input id="t-entry" placeholder="Цена входа">
                <input id="t-sl" placeholder="Stop Loss">
                <input id="t-tp" placeholder="Take Profit">
                <input id="t-rr" placeholder="RR">
                <button class="btn" onclick="addTrade()">ОТКРЫТЬ ПОЗИЦИЮ</button>`;
        }

        function addTrade() {
            const trade = {
                id: state.trades.length + 1,
                entry: document.getElementById('t-entry').value,
                res: '?'
            };
            state.trades.push(trade);
            state.status = 'В сделке';
            saveAll(); nav('scr-main');
        }

        function markAnalyzed() {
            const today = new Date().toISOString().slice(0,10);
            if(!state.history.includes(today)) state.history.push(today);
        }

        function renderCal() {
            const grid = document.getElementById('cal-render'); grid.innerHTML = '';
            const now = new Date();
            document.getElementById('month-name').innerText = now.toLocaleString('ru', {month:'long'});
            const days = new Date(now.getFullYear(), now.getMonth()+1, 0).getDate();
            for(let d=1; d<=days; d++) {
                const dateStr = `${now.getFullYear()}-${(now.getMonth()+1).toString().padStart(2,'0')}-${d.toString().padStart(2,'0')}`;
                const cls = state.history.includes(dateStr) ? 'day analyzed' : 'day';
                grid.innerHTML += `<div class="${cls}">${d}</div>`;
            }
        }

        function renderTrades() {
            const list = document.getElementById('trades-list'); list.innerHTML = '';
            state.trades.forEach((t, index) => {
                list.innerHTML += `
                    <div class="trade-item">
                        <span style="font-weight:900; font-size:12px;">#${t.id} Сделка</span>
                        <div>
                            ${t.res === '?' ? `
                                <button class="res-btn" style="background:var(--green)" onclick="setRes(${index}, 'W')">W</button>
                                <button class="res-btn" style="background:var(--red)" onclick="setRes(${index}, 'L')">L</button>
                                <button class="res-btn" style="background:#fff; color:#000" onclick="setRes(${index}, 'BE')">BE</button>
                            ` : `<b style="color:${t.res==='W'?'var(--green)':t.res==='L'?'var(--red)':'#fff'}">${t.res}</b>`}
                        </div>
                    </div>`;
            });
        }

        function setRes(idx, res) {
            state.trades[idx].res = res;
            state.status = 'Ожидание входа'; // После закрытия сделки возвращаемся в поиск
            saveAll(); renderTrades(); renderCurve();
        }

        function renderCurve() {
            const wins = state.trades.filter(t => t.res === 'W').length;
            const total = state.trades.filter(t => t.res !== '?').length;
            const wr = total > 0 ? Math.round((wins/total)*100) : 0;
            document.getElementById('winrate-val').innerText = wr + '%';
            
            const curve = document.getElementById('curve-render'); curve.innerHTML = '';
            state.trades.forEach(t => {
                if(t.res === '?') return;
                const h = t.res === 'W' ? '100%' : t.res === 'L' ? '20%' : '50%';
                const color = t.res === 'W' ? 'var(--green)' : t.res === 'L' ? 'var(--red)' : '#888';
                curve.innerHTML += `<div style="flex:1; height:${h}; background:${color}; border-radius:2px;"></div>`;
            });
        }

        function saveAll() {
            state.notes = document.getElementById('ui-notes').value || '';
            tg.CloudStorage.setItem('smc_q_v10', JSON.stringify(state));
            updateUI();
        }

        function updateUI() {
            document.getElementById('ui-phase').innerText = state.phase.toUpperCase();
            document.getElementById('ui-status').innerText = state.status.toUpperCase();
        }

        load();
    </script>
</body>
</html>